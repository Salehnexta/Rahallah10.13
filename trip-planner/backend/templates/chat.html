{% extends 'base.html' %}

{% block title %}Chat Assistant - {{ super() }}{% endblock %}

{% block head %}
{{ super() }}
<!-- Potentially add specific CSS for chat here -->
<style>
    /* Add some basic styling for chat messages */
    .chat-message {
        max-width: 75%;
        margin-bottom: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
    }
    .user-message {
        background-color: #d1e5f0; /* Light blue */
        margin-left: auto;
        border-bottom-right-radius: 0;
    }
    .assistant-message {
        background-color: #e9ecef; /* Light gray */
        margin-right: auto;
        border-bottom-left-radius: 0;
    }
    .system-message {
        font-style: italic;
        color: #6c757d; /* Gray text */
        text-align: center;
        margin: 0.5rem 0;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="chatApp()" class="max-w-3xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden">
    <div class="p-4 border-b">
        <h1 class="text-2xl font-semibold text-gray-800">Chat with AI Assistant</h1>
    </div>

    <!-- Chat Messages Area -->
    <div id="chat-window" class="p-4 h-[60vh] overflow-y-auto" x-ref="chatWindow">
        <template x-for="(msg, index) in messages" :key="index">
            <div :class="getChatMessageClass(msg)">
                <span x-html="formatMessageContent(msg.content)"></span>
                <div class="text-xs text-gray-500 mt-1" x-text="msg.timestamp"></div>
            </div>
        </template>
        <div x-show="isLoading" class="flex justify-center items-center mt-2">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-500"></div>
            <span class="ml-2 text-gray-500">Assistant is typing...</span>
        </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 border-t flex items-center space-x-3">
        <input type="text" 
               x-model="newMessage" 
               @keydown.enter="sendMessage()"
               placeholder="Type your message..." 
               aria-label="Chat message input"
               class="flex-grow px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               :disabled="isLoading">
        <button @click="sendMessage()"
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                :disabled="isLoading || !newMessage.trim()"
                title="Send Message">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Socket.IO Client Library -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<script>
    function chatApp() {
        return {
            messages: [],
            newMessage: '',
            isLoading: false,
            sessionId: 'session-' + Math.random().toString(36).substring(2, 15), // Simple session ID
            socket: null,

            init() {
                console.log("Chat app initializing...");
                this.connectWebSocket();

                // Scroll to bottom when messages change
                this.$watch('messages', () => {
                    this.$nextTick(() => {
                        this.scrollToBottom();
                    });
                });
                
                // Add initial welcome message
                this.addMessage("Welcome! Ask me anything about your trip.", "system");
            },

            connectWebSocket() {
                // Connect to the Socket.IO server (served by Flask)
                this.socket = io(); // Assumes same origin

                this.socket.on('connect', () => {
                    console.log('Connected to WebSocket server');
                    this.addMessage("Connected.", "system");
                    this.socket.emit('join', { session_id: this.sessionId });
                });

                this.socket.on('disconnect', (reason) => {
                    console.log('Disconnected from WebSocket:', reason);
                    this.addMessage("Disconnected. Trying to reconnect...", "system");
                    // Handle reconnection logic if needed
                });

                this.socket.on('connect_error', (error) => {
                    console.error('WebSocket connection error:', error);
                    this.addMessage("Connection error. Please refresh.", "system");
                });

                // Listen for responses from the backend
                this.socket.on('response', (data) => {
                    console.log('Received response:', data);
                    this.isLoading = false;
                    this.addMessage(data.response, 'assistant');
                    if (data.session_id) {
                        this.sessionId = data.session_id; // Update session ID if provided
                    }
                });
                
                // Listen for generic backend messages/status
                this.socket.on('status', (data) => {
                    console.log('Received status:', data);
                     this.addMessage(data.message, 'system');
                });
                 // Listen for errors from the backend
                this.socket.on('error', (data) => {
                    console.error('Received error:', data);
                    this.isLoading = false; // Stop loading indicator on error
                    this.addMessage(`Error: ${data.error || 'Unknown error'}`, 'system');
                });
            },

            sendMessage() {
                const messageContent = this.newMessage.trim();
                if (!messageContent || this.isLoading) {
                    return;
                }

                this.addMessage(messageContent, 'user');
                this.isLoading = true;

                // Send message via WebSocket
                if (this.socket && this.socket.connected) {
                     this.socket.emit('chat_message', {
                        session_id: this.sessionId,
                        message: messageContent
                    });
                } else {
                     this.addMessage("Cannot send message. Not connected.", "system");
                     this.isLoading = false;
                }

                this.newMessage = '';
            },

            addMessage(content, role) {
                this.messages.push({
                    content: content,
                    role: role, // 'user', 'assistant', 'system'
                    timestamp: new Date().toLocaleTimeString()
                });
            },

            formatMessageContent(content) {
                // Simple markdown formatting (e.g., **bold** to <strong>bold</strong>)
                // Basic XSS protection by escaping HTML tags - consider a more robust sanitizer if needed
                let escapedContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                return escapedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
             },
            
            getChatMessageClass(msg) {
                let baseClass = 'chat-message';
                if (msg.role === 'user') return `${baseClass} user-message`;
                if (msg.role === 'assistant') return `${baseClass} assistant-message`;
                return `${baseClass} system-message`; // System messages are styled differently
            },

            scrollToBottom() {
                const chatWindow = this.$refs.chatWindow;
                if (chatWindow) {
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            }
        }
    }
</script>
{% endblock %}
